<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Darts Chalking Trainer</title>

  <style>
    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,0.08);
      --panel2: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.7);
      --muted2: rgba(255,255,255,0.55);
      --accent: #7c5cff;
      --good: #28d17c;
      --bad: #ff4d4d;
      --shadow: 0 12px 30px rgba(0,0,0,0.35);
      --radius: 16px;
    }

    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(124,92,255,0.35), transparent 55%),
        radial-gradient(1000px 700px at 90% 15%, rgba(40,209,124,0.18), transparent 55%),
        radial-gradient(1000px 700px at 50% 95%, rgba(255,77,77,0.14), transparent 55%),
        linear-gradient(180deg, #070a14 0%, #0b1020 100%);
      display: grid;
      place-items: start center;
      padding: 28px 16px 40px;
    }

    a{ color: inherit; }
    .container{
      width: min(1100px, 100%);
      display: grid;
      gap: 16px;
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
    }
    .logo{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(124,92,255,1), rgba(40,209,124,0.9));
      box-shadow: var(--shadow);
    }
    .brand h1{
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.2px;
    }
    .brand p{
      margin: 2px 0 0;
      color: var(--muted2);
      font-size: 13px;
    }

    /* Connection pill (uses your existing #highscore-status element) */
    #highscore-status{
      width: auto;
      height: auto;
      border-radius: 999px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.12);
      border: 1px solid var(--border);
      display:flex;
      align-items:center;
      gap: 10px;
      cursor: help;
      user-select: none;
    }
    #highscore-status::before{
      content:"";
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: gray; /* updated by JS */
      box-shadow: 0 0 0 3px rgba(255,255,255,0.06);
    }
    #highscore-status .label{
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
    }

    /* Panels */
    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .panel .hd{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .panel .hd h2, .panel .hd h3{
      margin: 0;
      font-size: 14px;
      letter-spacing: 0.2px;
      color: rgba(255,255,255,0.88);
    }
    .panel .bd{
      padding: 14px 16px 16px;
    }

    /* Layout grid */
    .grid{
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap: 16px;
    }
    @media (max-width: 920px){
      .grid{ grid-template-columns: 1fr; }
    }

    /* Score cards */
    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    @media (max-width: 520px){
      .stats{ grid-template-columns: 1fr; }
    }
    .stat{
      background: var(--panel2);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 12px 12px;
      min-height: 64px;
    }
    .stat .k{
      font-size: 12px;
      color: var(--muted2);
      margin-bottom: 6px;
    }
    .stat .v{
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }
    #timer.red{ color: var(--bad); }
    .pill{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
    }

    /* Canvas */
    #dartboard{
      display:block;
      width: 100%;
      max-width: 520px;
      height: auto;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 18px 50px rgba(0,0,0,0.35);
      background: rgba(0,0,0,0.18);
      margin: 10px auto 0;
    }

    /* Form controls */
    .controlsRow{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
    }
    label{ color: var(--muted); font-size: 13px; }
    input, select, button{
      font: inherit;
    }
    input[type="number"], input[type="text"], select{
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.14);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
      min-height: 40px;
    }
    input::placeholder{ color: rgba(255,255,255,0.45); }
    select{ padding-right: 28px; }
    button{
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.10);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 14px;
      min-height: 40px;
      cursor: pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
    }
    button:hover{
      background: rgba(255,255,255,0.14);
      border-color: rgba(255,255,255,0.22);
    }
    button:active{ transform: translateY(1px); }

    .primary{
      background: linear-gradient(135deg, rgba(124,92,255,0.95), rgba(124,92,255,0.55));
      border-color: rgba(124,92,255,0.6);
    }
    .primary:hover{
      background: linear-gradient(135deg, rgba(124,92,255,1), rgba(124,92,255,0.65));
    }
    .danger{
      background: rgba(255,77,77,0.16);
      border-color: rgba(255,77,77,0.35);
    }
    .ghost{
      background: rgba(255,255,255,0.06);
    }

    /* Throws + message */
    #throws{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      color: rgba(255,255,255,0.88);
      min-height: 44px;
    }
    #message{
      margin-top: 10px;
      color: rgba(255,255,255,0.9);
      min-height: 20px;
    }
    .red{ color: var(--bad); }
    .hidden{ display: none; }

    /* Highscores: keep your IDs but style them */
    #highScores{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (max-width: 720px){
      #highScores{ grid-template-columns: 1fr; }
    }
    #dailyHighs, #allTimeHighs{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    #dailyHighs h3, #allTimeHighs h3{
      margin: 0;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      font-size: 14px;
      color: rgba(255,255,255,0.88);
      letter-spacing: 0.2px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
    }
    #dailyHard, #allTimeHard{
      padding: 12px 16px 16px;
      color: rgba(255,255,255,0.86);
      font-size: 13px;
    }
    #dailyHard p, #allTimeHard p{
      margin: 8px 0;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
    }

    /* Instructions */
    .instructions ul{
      margin: 10px 0 0;
      padding-left: 18px;
      color: var(--muted);
      line-height: 1.55;
      font-size: 13px;
    }
    .instructions .note{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(124,92,255,0.35);
      background: rgba(124,92,255,0.10);
      color: rgba(255,255,255,0.86);
      font-size: 13px;
    }

    /* Submission form (keep your ID) */
    #submissionForm{
      margin-top: 0;
      border: 1px solid rgba(255,255,255,0.14);
      padding: 14px 16px 16px;
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      max-width: 100%;
    }
    #submissionForm h3{
      margin: 0 0 10px 0;
      font-size: 14px;
      color: rgba(255,255,255,0.88);
    }

    /* Checkbox line */
    .toggle{
      display:flex;
      align-items:center;
      gap: 10px;
      justify-content:center;
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
    }
    input[type="checkbox"]{
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .footerHint{
      text-align:center;
      color: var(--muted2);
      font-size: 12px;
      margin-top: 6px;
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- Top bar -->
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Darts Chalking Trainer</h1>
          <p>Practice scoring quickly and accurately under time pressure.</p>
        </div>
      </div>

      <!-- Keep the same element ID, but render as a pill -->
      <div id="highscore-status" title="Highscore connection status">
        <span class="label">Highscores</span>
      </div>
    </div>

    <!-- Highscores (same IDs) -->
    <div id="highScores">
      <div id="dailyHighs">
        <h3>
          <span>Daily High Scores (Hard)</span>
          <span class="pill">today</span>
        </h3>
        <div id="dailyHard"></div>
      </div>
      <div id="allTimeHighs">
        <h3>
          <span>All-Time High Scores (Hard)</span>
          <span class="pill">top 10</span>
        </h3>
        <div id="allTimeHard"></div>
      </div>
    </div>

    <div class="grid">

      <!-- Left: Game -->
      <div class="panel">
        <div class="hd">
          <h2>Live Turn</h2>
          <span class="pill">501 → Checkout</span>
        </div>
        <div class="bd">
          <div class="stats">
            <div class="stat">
              <div class="k">Current Score</div>
              <div class="v"><span id="currentScore">501</span></div>
            </div>
            <div class="stat">
              <div class="k">Time Left</div>
              <div class="v"><span id="timer" class="red">0s</span></div>
            </div>
            <div class="stat">
              <div class="k">Difficulty</div>
              <div class="v" id="difficultyReadout">Easy</div>
            </div>
          </div>

          <canvas id="dartboard" width="450" height="450"></canvas>

          <div id="throws"></div>

          <div class="toggle" id="showTotalLabel">
            <input type="checkbox" id="showTotal" checked>
            <span>Show total of the 3 darts (not shown on Hard)</span>
          </div>

          <div class="controlsRow" style="margin-top: 12px;">
            <input type="number" id="scoreInput" placeholder="Enter new score (after 3 darts)" inputmode="numeric" />
            <button class="primary" onclick="submitScore()">Submit</button>
          </div>

          <div id="message"></div>

          <div class="controlsRow" id="controls" style="margin-top: 12px;">
            <label>
              Difficulty:
              <select id="difficulty">
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="hard">Hard</option>
              </select>
            </label>

            <button class="ghost" onclick="startTurn()">Start Turn</button>
            <button class="danger" onclick="resetGame()">Reset Game</button>
            <button onclick="testHighScore()">Test High Score</button>
          </div>

          <div class="footerHint">Tip: in Hard mode, the “Show total” helper is hidden—like real chalking.</div>
        </div>
      </div>

      <!-- Right: Instructions + Submission -->
      <div class="panel instructions">
        <div class="hd">
          <h2>How to Play</h2>
          <span class="pill">chalking practice</span>
        </div>
        <div class="bd">
          <ul>
            <li>Click <b>Start Turn</b> to generate up to 3 dart throws for your current score.</li>
            <li>Mentally subtract the throws from the <b>Current Score</b> (normal 501 rules).</li>
            <li>Type the <b>new score</b> into the box and press <b>Submit</b> before time runs out.</li>
            <li><b>Bust rules:</b> if the score would go below 0, the score stays the same.</li>
            <li><b>Checkout:</b> you must finish on a <b>double</b> (D) or <b>Bull</b>.</li>
            <li><b>Difficulty:</b> Easy gives more time and may show the total; Hard is fastest and hides the total helper.</li>
          </ul>

          <div class="note">
            <b>Scoring goal:</b> Finish 501 as fast as possible. When you checkout, you can submit your time to the Hard leaderboard.
          </div>

          <!-- Keep same ID / structure -->
          <div id="submissionForm" class="hidden" style="margin-top: 14px;">
            <h3>Submit Your Score</h3>
            <div class="controlsRow" style="justify-content:flex-start;">
              <input type="text" id="username" placeholder="Enter username" />
              <label for="country" style="display:flex; align-items:center; gap:8px;">
                Country:
                <select id="country"></select>
              </label>
            </div>
            <div class="controlsRow" style="justify-content:flex-start; margin-top: 8px;">
              <button class="primary" onclick="submitHighScore()">Submit</button>
              <button class="ghost" onclick="continueGame()">Continue</button>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";
    import { getDatabase, ref, onValue, get, set } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDTidIF53SjPRXHncIFy1bFWfbpmp1y6wc",
      authDomain: "chalktrainer.firebaseapp.com",
      databaseURL: "https://chalktrainer-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "chalktrainer",
      storageBucket: "chalktrainer.firebasestorage.app",
      messagingSenderId: "605519698736",
      appId: "1:605519698736:web:3cf1479d263774081c46f5",
      measurementId: "G-9XKPXNV8D9"
    };

    let app, database, analytics;
    try {
      app = initializeApp(firebaseConfig);
      database = getDatabase(app);
      analytics = getAnalytics(app);
    } catch (error) {
      console.error("Firebase initialization failed:", error);
      updateStatusButton(false);
    }

    if (database) {
      const connectedRef = ref(database, '.info/connected');
      onValue(connectedRef, (snapshot) => {
        const connected = snapshot.val();
        console.log('Connection status:', connected);
        updateStatusButton(connected);
      });

      setInterval(() => {
        const highscoresRef = ref(database, 'highscores');
        get(highscoresRef).then(() => {
          console.log('Periodic check: connected');
          updateStatusButton(true);
        }).catch((error) => {
          console.error('Periodic check: disconnected', error);
          updateStatusButton(false);
        });
      }, 5000);
    } else {
      updateStatusButton(false);
    }

    function updateStatusButton(connected) {
      const statusButton = document.getElementById('highscore-status');
      // we now style via ::before, so update the pseudo "dot" using inline style fallback:
      // easiest: set a CSS variable on the element and use it in ::before
      statusButton.style.setProperty('--dot', connected ? 'green' : 'red');
      // but since ::before is defined with background gray, we update by toggling a data attr:
      statusButton.dataset.connected = connected ? "1" : "0";
      // and directly set the dot color by swapping the element background on the ::before fallback:
      // (we'll also set the element border tint subtly)
      statusButton.style.borderColor = connected ? 'rgba(40,209,124,0.45)' : 'rgba(255,77,77,0.45)';

